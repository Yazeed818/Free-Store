<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>إبصار — إدارة الملفات (متكامل)</title>
  <meta name="description" content="نظام محلي لإدارة الملفات — إنشاء الحسابات بواسطة الأدمن فقط، واجهة متجاوبة وقوية." />
google-site-verification=RA-i08cphtNr55LAnzTQLCoZG4doZJWbGEnZc8EI93s
  <!-- =======================
       Google AdSense script
       ملاحظة: هذا السكربت لا يغيّر من منطق التطبيق — فقط يُحمّل مكتبة الإعلانات.
       استبدل client و data-ad-slot بالقيم الحقيقية لديك عند الحاجة.
       ======================= -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3379548904465151"
     crossorigin="anonymous"></script>

  <style>
    :root{ --bg:#071427; --card:#0b2233; --accent:#06b6d4; --muted:#9fb0c8; --glass: rgba(255,255,255,0.03); }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Arial;direction:rtl}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#031026 0%,#061329 100%);color:#e6eef6}
    .wrap{max-width:1200px;margin:16px auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:800}
    h1{margin:0;font-size:20px}
    .sub{color:var(--muted);font-size:13px}
    nav .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:inherit;cursor:pointer}
    .hero{margin-top:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);display:flex;justify-content:space-between;align-items:center}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:14px;margin-top:14px}
    .card{background:linear-gradient(180deg,var(--card),#071827);padding:14px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    input,select,button,textarea{font-size:14px;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:#071827;color:inherit}
    label{font-size:13px;margin-bottom:6px}
    .small{font-size:13px;color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .item{padding:12px;border-radius:10px;background:var(--glass);display:flex;align-items:center;justify-content:space-between;gap:12px}
    .meta{font-size:13px;color:var(--muted)}
    .watermark{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) rotate(-25deg);opacity:0.04;font-size:48px;pointer-events:none;user-select:none;z-index:3000}
    .block-overlay{position:fixed;inset:0;background:rgba(7,18,39,0.96);z-index:4000;color:#fff;display:none;align-items:center;justify-content:center;flex-direction:column;padding:20px}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;align-items:center}
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;z-index:5000}
    .modal{width:880px;background:#071827;padding:18px;border-radius:12px;max-height:90vh;overflow:auto}
    .form-row{margin-bottom:10px;display:flex;flex-direction:column}
    .pw-meter{height:8px;border-radius:6px;background:rgba(255,255,255,0.04);overflow:hidden}
    .pw-meter > div{height:100%;width:0%}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;color:inherit;cursor:pointer}
    .top-actions{display:flex;gap:8px;align-items:center}
    .badge{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-size:13px}
    .file-item{display:flex;flex-direction:column;gap:6px}
    .row{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted)}
    .danger{color:#ff6b6b}
    .success{color:#4ade80}
    pre{white-space:pre-wrap}
    .app-logo{width:72px;height:72px;border-radius:12px;object-fit:cover;border:1px solid rgba(255,255,255,0.04);margin-left:8px}
    .channel-entry{display:flex;align-items:center;gap:12px}
    .tabs{display:flex;gap:8px;margin-bottom:10px}
    .thumb{width:80px;height:80px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,0.04)}
    .table{width:100%;border-collapse:collapse}
    .table th, .table td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:right}
    .muted-2{color:#8899aa}
    .files-toolbar{display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
    .folder-breadcrumb{font-size:13px;color:var(--muted);margin-bottom:8px}
    .file-list{display:flex;flex-direction:column;gap:8px}
    .file-row{display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px}
    @media(max-width:920px){.grid{grid-template-columns:1fr}.modal{width:94%}}
  </style>
</head>
<body>
  <div class="watermark" id="watermark">إبصار</div>

  <div class="block-overlay" id="blocker">
    <h2>تم حظر الوصول</h2>
    <p id="blockReason" class="muted">تم اكتشاف سلوك غير مسموح.</p>
    <div style="margin-top:12px"><button id="unblockBtn" class="btn">إلغاء الحظر (اختباري)</button></div>
  </div>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">إ</div>
        <div>
          <h1>نظام إبصار — إدارة الحسابات والملفات</h1>
          <div class="sub">الحسابات يُنشئها الأدمن فقط — وتنظيم الملفات محليًا.</div>
        </div>
      </div>
      <nav id="topNav"></nav>
    </header>

    <div class="hero card">
      <div>
        <h2>لوحة التحكم</h2>
        <p class="small"> ايميل الادمن yazeeddd81@gmail.com مرحبا بكم في عصر الملفات الحديثه</p>
        
      </div>
      <div class="top-actions">
        <div class="badge"><span id="statusMsg">جاهز</span></div>
        <div style="display:flex;gap:8px">
          <button id="openPanel" class="btn">افتح الواجهة</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <aside id="leftPanel" class="card"></aside>
      <main id="mainPanel" class="card"></main>
    </div>

    <!-- =========================
         Non-intrusive ad slot (بعد اللوحة الرئيسية، قبل الفوتر)
         هذا المكان ثابت ولا يتداخل مع منطق JS الرئيسي.
         استبدل data-ad-slot بالقيمة الحقيقية.
         ========================= -->
    <div style="margin-top:12px" aria-hidden="true">
      <div class="card" style="padding:10px;text-align:center;">
        <!-- ad: responsive — ضع هنا data-ad-slot الصحيح -->
        <ins class="adsbygoogle"
             style="display:block; max-width:100%; height:90px; margin:0 auto;"
             data-ad-client="ca-pub-3379548904465151"
             data-ad-slot="REPLACE_WITH_SLOT"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
          try{ (adsbygoogle = window.adsbygoogle || []).push({}); }catch(e){ console.warn('adsbygoogle push failed', e); }
        </script>
        <div class="small muted" style="margin-top:6px">إعلان (مكان هادئ — )</div>
      </div>
    </div>

    <footer>  جميع الحقوق محفوضه لتواصل مع الادمن الايميل yazeeddd@gmail.com</footer>
  </div>

  <!-- =========================
       احتياطي: مكان إعلان صغير تحت الـ wrap (لن يتداخل مع JS)
       يمكنك حذف أحد الأماكن إذا أردت عرض إعلان واحد فقط.
       ========================= -->
  <div style="text-align:center;margin:8px 0" aria-hidden="true">
    <ins class="adsbygoogle"
         style="display:block; max-width:320px; height:50px; margin:0 auto;"
         data-ad-client="ca-pub-3379548904465151"
         data-ad-slot="REPLACE_WITH_SLOT"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
      try{ (adsbygoogle = window.adsbygoogle || []).push({}); }catch(e){ console.warn('adsbygoogle push failed', e); }
    </script>
  </div>

  <div id="modalRoot" class="modal-backdrop" aria-hidden="true"></div>

<script>
/* ============================================================
  تطوير: إضافة مدير ملفات (مجلدات/ملفات)، ترتيب، نقل، إعادة تسمية، تصدير JSON لكل مستخدم،
           وميزة قفل الحساب عند انتهاء الشهادة أو يدويًا (الأدمن).
   ملاحظات سريعة:
   - الملفات مخزنة في objectStore 'files' مع حقل blob (Blob).
   - تصدير JSON لكل مستخدم يتضمن الملفات كمحتوى base64 حتى يستطيع المستخدم حفظ "حقّه".
   - إذا تم قفل الحساب (locked=true) فلن يستطيع المستخدم تسجيل الدخول لكن ملفاته تبقى.
  ملاحظة: إضافة عناصر الإعلانات أعلاه تمت في أماكن ثابتة لا تؤثر على عناصر DOM التي يتعامل معها السكربت (leftPanel، mainPanel...).
   ============================================================ */

const DB_NAME = 'ibsar_manager_v1';
const DB_VER = 4; // bumped version for new file schema
const ADMIN_EMAIL = 'yazeeddd81@gmail.com';
const ADMIN_PLAIN = 'Tt12344+';

const $ = s => document.querySelector(s);
const uid = ()=> Date.now().toString(36) + Math.random().toString(36).slice(2,8);
let currentUser = null; let sessionToken = null; let sessionChecker = null; let blocked=false;

/* ---------- crypto helpers (unchanged) ---------- */
function toBase64(buf){ let binary=''; const view=new Uint8Array(buf); for(let i=0;i<view.length;i++) binary+=String.fromCharCode(view[i]); return btoa(binary); }
function fromBase64(b64){ const bin=atob(b64); const arr=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i); return arr; }
async function hashPassword(password){ const enc=new TextEncoder().encode(password); const salt=crypto.getRandomValues(new Uint8Array(16)); const key=await crypto.subtle.importKey('raw',enc,'PBKDF2',false,['deriveBits']); const derived=await crypto.subtle.deriveBits({name:'PBKDF2',salt,iterations:200000,hash:'SHA-256'},key,256); return `${toBase64(salt)}$${toBase64(derived)}`; }
async function verifyPassword(password, stored){ if(!stored||typeof stored!=='string') return false; const parts=stored.split('$'); if(parts.length!==2) return false; const salt=fromBase64(parts[0]); const expected=parts[1]; const enc=new TextEncoder().encode(password); const key=await crypto.subtle.importKey('raw',enc,'PBKDF2',false,['deriveBits']); const derived=await crypto.subtle.deriveBits({name:'PBKDF2',salt,iterations:200000,hash:'SHA-256'},key,256); return toBase64(derived)===expected; }

/* ---------- IndexedDB (upgrade for files schema) ---------- */
function openDB(){ return new Promise((resolve,reject)=>{ try{ const req=indexedDB.open(DB_NAME,DB_VER); req.onupgradeneeded=e=>{ const db=e.target.result; if(!db.objectStoreNames.contains('accounts')) db.createObjectStore('accounts',{keyPath:'id'}); if(!db.objectStoreNames.contains('files')) db.createObjectStore('files',{keyPath:'id'}); if(!db.objectStoreNames.contains('sessions')) db.createObjectStore('sessions',{keyPath:'token'}); if(!db.objectStoreNames.contains('verifications')) db.createObjectStore('verifications',{keyPath:'id'}); /* migrate or initialize if needed */ }; req.onsuccess=()=>resolve(req.result); req.onerror=()=>reject(req.error||new Error('IDB open error')); }catch(err){ reject(err);} }); }
async function idbPut(store,val){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(store,'readwrite'); const os=tx.objectStore(store); const r=os.put(val); r.onsuccess=()=>res(true); r.onerror=e=>rej(e.target.error||new Error('put failed')); }); }
async function idbGetAll(store){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(store,'readonly'); const req=tx.objectStore(store).getAll(); req.onsuccess=()=>res(req.result||[]); req.onerror=e=>rej(e.target.error||new Error('getAll failed')); }); }
async function idbGet(store,key){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(store,'readonly'); const req=tx.objectStore(store).get(key); req.onsuccess=()=>res(req.result); req.onerror=e=>rej(e.target.error||new Error('get failed')); }); }
async function idbDelete(store,key){ const db=await openDB(); return new Promise((res,rej)=>{ const tx=db.transaction(store,'readwrite'); const req=tx.objectStore(store).delete(key); req.onsuccess=()=>res(true); req.onerror=e=>rej(e.target.error||new Error('delete failed')); }); }

/* ---------- utilities ---------- */
function createCard(html){ const d=document.createElement('div'); d.className='card'; d.innerHTML=html; return d; }
function showModal(html){ const root=$('#modalRoot'); if(!root) return; root.style.display='flex'; root.setAttribute('aria-hidden','false'); root.innerHTML=html; }
function closeModal(){ const root=$('#modalRoot'); if(!root) return; root.style.display='none'; root.setAttribute('aria-hidden','true'); root.innerHTML=''; }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"]+/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]||c)); }
function simpleEmailCheck(email){ if(!email) return false; const at=email.indexOf('@'); const dot=email.lastIndexOf('.'); return at>0 && dot>at+1 && dot<email.length-1; }
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function generatePassword(len=12){ const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:,.<>?'; let out=''; for(let i=0;i<len;i++) out += chars.charAt(Math.floor(Math.random()*chars.length)); return out; }
function generateEmailFromName(name){ const clean = name.trim().toLowerCase().replace(/[^a-z0-9]+/g,'.').replace(/(^\.|\.$)/g,''); const suffix = Date.now().toString(36).slice(-4); return `${clean||'user'}.${suffix}@ibsar.local`; }

/* ---------- file system helpers ---------- */
/*
  files store schema:
  {
    id, ownerId, name, type: 'file'|'folder', folder: 'path/like', size, mime, createdAt, updatedAt, blob?(for file), meta: {}
  }
*/
async function createFolder(ownerId, path, folderName){
  const id = uid();
  const now = Date.now();
  const entry = { id, ownerId, name:folderName, type:'folder', folder: path||'', createdAt:now, updatedAt:now };
  await idbPut('files', entry);
  return entry;
}
async function uploadFileObject(ownerId, folderPath, file){ // file: File
  const id = uid();
  const now = Date.now();
  const entry = { id, ownerId, name: file.name, type:'file', folder: folderPath||'', size: file.size, mime: file.type||'application/octet-stream', createdAt: now, updatedAt: now, blob: file };
  await idbPut('files', entry);
  return entry;
}
async function getUserFiles(ownerId, folderPath = ''){ const all = await idbGetAll('files'); return all.filter(f => f.ownerId === ownerId && (f.folder||'') === (folderPath||'')); }
async function getAllUserFolders(ownerId){ const all = await idbGetAll('files'); return all.filter(f => f.ownerId === ownerId && f.type==='folder'); }
async function moveFileTo(id, newFolder){ const f = await idbGet('files', id); if(!f) throw new Error('not found'); f.folder = newFolder||''; f.updatedAt = Date.now(); await idbPut('files', f); return f; }
async function renameFile(id, newName){ const f = await idbGet('files', id); if(!f) throw new Error('not found'); f.name = newName; f.updatedAt = Date.now(); await idbPut('files', f); return f; }
async function deleteFileEntry(id){ // deletes file/folder entry (does not recursively delete folder contents in this vanilla impl)
  const f = await idbGet('files', id);
  if(!f) throw new Error('not found');
  // if folder, delete its children too (safer)
  if(f.type === 'folder'){
    const all = await idbGetAll('files');
    const children = all.filter(x => x.ownerId === f.ownerId && (x.folder||'') === (f.name ? (f.name) : '')); // simple flat folders
    // simple approach: delete children that have folder equal to folder name (non-nested)
    for(const c of children) await idbDelete('files', c.id);
  }
  await idbDelete('files', id);
  return true;
}
function blobToBase64(blob){ return new Promise((resolve,reject)=>{ const reader = new FileReader(); reader.onload = ()=> { const b64 = reader.result.split(',',2)[1]; resolve(b64); }; reader.onerror = err => reject(err); reader.readAsDataURL(blob); }); }

/* ---------- session & lock enforcement ---------- */
async function createSession(userId, remember=false){ const token=uid(); const expires=Date.now() + (remember?1000*60*60*24*30:1000*60*60*6); const s={token,userId,expires}; await idbPut('sessions',s).catch(()=>{}); sessionStorage.setItem('ibsar_session',JSON.stringify(s)); if(remember) localStorage.setItem('ibsar_session_remember',JSON.stringify(s)); return s; }
async function loadSessionFromStorage(){ try{ let s=sessionStorage.getItem('ibsar_session')||localStorage.getItem('ibsar_session_remember'); if(!s) return null; s=JSON.parse(s); if(!s||!s.token) return null; const st=await idbGet('sessions',s.token).catch(()=>null); if(!st) return null; if(Date.now()>st.expires){ await idbDelete('sessions',st.token); sessionStorage.removeItem('ibsar_session'); localStorage.removeItem('ibsar_session_remember'); return null; } sessionToken=st; return st;}catch(e){return null;} }
async function endSession(){ try{ if(sessionToken && sessionToken.token) await idbDelete('sessions',sessionToken.token); }catch(e){} sessionToken=null; currentUser=null; sessionStorage.removeItem('ibsar_session'); localStorage.removeItem('ibsar_session_remember'); sessionStorage.removeItem('currentUser'); await renderApp(); }

/* enforce certificate locks: if acc.lockOnCertExpire true and certificateExpires <= now => set locked=true (files preserved) */
async function enforceCertificateLocks(){
  const accounts = await idbGetAll('accounts');
  const now = Date.now();
  for(const a of accounts){
    if(a.lockOnCertExpire && a.certificateExpires && a.certificateExpires > 0 && a.certificateExpires <= now){
      if(!a.locked){ a.locked = true; await idbPut('accounts', a); }
    }
  }
}

/* ---------- render / navigation (extended) ---------- */
async function renderAuthArea(){ const nav=$('#topNav'); if(!nav) return; if(currentUser){ nav.innerHTML=`<span class="small">${escapeHtml(currentUser.role||'')} — ${escapeHtml(currentUser.email||'')}${currentUser.mustChangePassword? ' <strong style="color:#f59e0b">(يجب تغيير كلمة المرور)</strong>':''}${currentUser.locked? ' <strong style="color:#ff6b6b">(مقفل)</strong>':''}</span> <span class="controls"><button id="logoutBtn" class="btn">خروج</button></span>`; $('#logoutBtn').onclick=async()=>{ await endSession(); }; } else { nav.innerHTML=`<div style="display:flex;gap:8px;align-items:center"><button id="btnLogin" class="btn">دخول</button></div>`; $('#btnLogin').onclick=showLoginModal; } }

async function renderApp(){ await enforceCertificateLocks(); await renderAuthArea(); const left=$('#leftPanel'), main=$('#mainPanel'); if(!left||!main) return; left.innerHTML=''; main.innerHTML=''; if(blocked){ $('#blocker').style.display='flex'; return; } else $('#blocker').style.display='none'; if(!currentUser){ left.appendChild(createCard('<h3>مرحبًا بك</h3><div class="small">سجّل دخول الأدمن لإدارة الحسابات والملفات.</div>')); main.appendChild(createCard('<h3>نظام إدارة محلي</h3><div class="small">‏</div>')); return; }
  if(currentUser.role==='admin'){
    left.appendChild(createCard(`<h3>لوحة الأدمن</h3><div class="small">${escapeHtml(currentUser.name||currentUser.email)}</div>`));
    const actions = `<div class="list"><div class="item"><button id="createUserBtn" class="btn">إنشاء حساب جديد</button></div><div class="item"><button id="manageUsersBtn" class="btn">إدارة الحسابات</button></div><div class="item"><button id="backupBtn" class="btn">تنزيل نسخة احتياطية</button></div><div class="item"><button id="importBtn" class="btn">استيراد نسخة</button></div></div>`;
    left.appendChild(createCard(actions));
    $('#createUserBtn').onclick = showCreateUserModal;
    $('#manageUsersBtn').onclick = renderUsersManager;
    $('#backupBtn').onclick = downloadBackup;
    $('#importBtn').onclick = () => { showImportModal(); };

    main.appendChild(createCard('<h3>لوحة الإدارة</h3><div id="adminMainArea"></div>'));
    renderDashboard();
  } else {
    left.appendChild(createCard('<h3>لوحة المستخدم</h3><div class="small">حسابك الشخصي</div>'));
    main.appendChild(createCard('<h3>حسابي</h3><div id="userArea"></div>'));
    renderUserArea();
  }
}

/* ---------- dashboard & notifications (unchanged) ---------- */
async function renderDashboard(){ const area=$('#adminMainArea'); if(!area) return; const users = await idbGetAll('accounts'); const now=Date.now(); const expiringSubs = users.filter(u=> u.subscriptionExpires && u.subscriptionExpires - now < 1000*60*60*24*7 && u.subscriptionExpires > now); const expiredSubs = users.filter(u=> u.subscriptionExpires && u.subscriptionExpires <= now);
  const expiringCerts = users.filter(u=> u.certificateExpires && u.certificateExpires - now < 1000*60*60*24*7 && u.certificateExpires > now);
  const expiredCerts = users.filter(u=> u.certificateExpires && u.certificateExpires <= now);
  let html = `<div class="row" style="gap:12px"><div style="flex:1">`;
  html += `<div class="small">إجمالي الحسابات: <strong>${users.length}</strong></div>`;
  html += `<div style="height:12px"></div>`;
  html += `<div class="small">الاشتراكات منتهية: <strong>${expiredSubs.length}</strong> — تنتهي خلال أسبوع: <strong>${expiringSubs.length}</strong></div>`;
  html += `<div class="small">الشهادات منتهية: <strong>${expiredCerts.length}</strong> — تنتهي خلال أسبوع: <strong>${expiringCerts.length}</strong></div>`;
  html += `</div><div style="width:300px">`;
  html += `<button id="goManage" class="btn">اذهب لإدارة الحسابات</button>`;
  html += `</div></div><div style="height:12px"></div>`;
  html += `<div><h4>تنبيهات سريعة</h4><div class="small">`;
  if(expiredSubs.length) html += `<div class="item">يوجد ${expiredSubs.length} اشتراك منتهي — راجع قائمة الحسابات</div>`;
  if(expiredCerts.length) html += `<div class="item">يوجد ${expiredCerts.length} شهادة منتهية</div>`;
  if(!expiredSubs.length && !expiredCerts.length) html += `<div class="small">لا توجد تنبيهات حالية.</div>`;
  html += `</div></div>`;
  area.innerHTML = html;
  document.getElementById('goManage').onclick = renderUsersManager;
}

/* ---------- Create user modal (admin) (unchanged) ---------- */
function showCreateUserModal(){ showModal(`<div class="modal"><h3>إنشاء حساب جديد</h3>
  <div class="form-row"><label>اسم المستخدم (إجباري)</label><input id="cu_name" placeholder="اسم الشخص"></div>
  <div class="form-row"><label>دور الحساب</label><select id="cu_role"><option value="user">مستخدم</option><option value="admin">أدمن</option></select></div>
  <div class="form-row"><button id="cu_create" class="btn">إنشاء</button> <button id="cu_cancel" class="btn">إلغاء</button></div>
</div>`);
  document.getElementById('cu_cancel').onclick = closeModal;
  document.getElementById('cu_create').onclick = async ()=>{ 
    const name = (document.getElementById('cu_name')||{}).value.trim(); const role = (document.getElementById('cu_role')||{}).value||'user';
    if(!name) return alert('اكتب اسم المستخدم');
    const email = generateEmailFromName(name);
    const plain = generatePassword();
    const hashed = await hashPassword(plain);
    const id = uid();
    const now = Date.now();
    const subscriptionExpires = 0;
    const acc = { id, name, email, passwordHash: hashed, role, mustChangePassword:true, subscriptionExpires: subscriptionExpires||0, subscriptionActive: false, certificateExpires: 0, emailVerified:true, createdAt: now, lockOnCertExpire:false, locked:false };
    await idbPut('accounts', acc);
    alert(`تم إنشاء الحساب.
البريد: ${email}
كلمة المرور (موقتة): ${plain}
على المستخدم تغيير كلمة المرور عند أول دخول.`);
    closeModal();
    await renderApp();
  };
}

/* ---------- Users manager (admin) extended ---------- */
async function renderUsersManager(){ const area=$('#mainPanel'); if(!area) return; const users = await idbGetAll('accounts'); let html = '<h3>إدارة الحسابات</h3>';
  html += `<div style="margin-bottom:8px"><input id="um_search" placeholder="ابحث بالاسم أو البريد" style="width:60%"> <button id="um_doSearch" class="btn">بحث</button> <button id="um_refresh" class="btn">تحديث</button></div>`;
  html += '<div id="usersTableWrapper"></div>';
  area.innerHTML = createCard(html).innerHTML;
  document.getElementById('um_doSearch').onclick = ()=> populate(); document.getElementById('um_refresh').onclick = ()=> populate();
  populate();
  async function populate(){ const q = ((document.getElementById('um_search')||{}).value||'').trim().toLowerCase(); const list = (await idbGetAll('accounts')).filter(u=> !q || (u.name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q));
    const wrapper = document.getElementById('usersTableWrapper'); if(!wrapper) return; let t = '<table class="table"><thead><tr><th>الاسم</th><th>البريد</th><th>دور</th><th>الاشتراك</th><th>الشهادة</th><th>حالة</th><th>أوامر</th></tr></thead><tbody>';
    const now=Date.now(); list.forEach(u=>{
      const sub = u.subscriptionExpires && u.subscriptionExpires>0 ? new Date(u.subscriptionExpires).toLocaleDateString() : '-';
      const cert = u.certificateExpires && u.certificateExpires>0 ? new Date(u.certificateExpires).toLocaleDateString() : '-';
      const status = (u.subscriptionActive && u.subscriptionExpires && u.subscriptionExpires > now) ? '<span class="success">نشط</span>' : '<span class="danger">منتهي</span>';
      const lockedBadge = u.locked ? ' <span class="danger">مقفل</span>' : '';
      t += `<tr><td>${escapeHtml(u.name||'')}</td><td>${escapeHtml(u.email||'')}</td><td>${escapeHtml(u.role||'')}</td><td>${sub}</td><td>${cert}</td><td>${status}${lockedBadge}</td><td>
        <button class="btn" data-id="${u.id}" data-action="edit">تعديل</button> 
        <button class="btn" data-id="${u.id}" data-action="pass">كلمة السر</button> 
        <button class="btn" data-id="${u.id}" data-action="extend">تمديد</button> 
        <button class="btn" data-id="${u.id}" data-action="cert">شهادة</button> 
        <button class="btn" data-id="${u.id}" data-action="lock">قفل/فتح</button> 
        <button class="btn" data-id="${u.id}" data-action="exportfiles">تصدير ملفات</button> 
        <button class="btn" data-id="${u.id}" data-action="cancel">إلغاء</button> 
        <button class="btn" data-id="${u.id}" data-action="del">حذف</button>
      </td></tr>`;
    });
    t += '</tbody></table>';
    wrapper.innerHTML = t;
    wrapper.querySelectorAll('button[data-action]').forEach(b=> b.onclick=async e=>{
      const id = e.target.dataset.id; const act = e.target.dataset.action; const acc = await idbGet('accounts', id);
      if(!acc) return alert('الحساب غير موجود');
      if(act==='edit'){ showEditUserModal(acc); }
      if(act==='pass'){ const np = prompt('كلمة المرور الجديدة (اتركها لعمل كلمة عشوائية)'); if(np===null) return; const pass = np||generatePassword(); acc.passwordHash = await hashPassword(pass); acc.mustChangePassword = true; await idbPut('accounts', acc); alert('تم تغيير كلمة المرور. كلمة المرور الجديدة: ' + pass); renderUsersManager(); }
      if(act==='extend'){ const months = parseInt(prompt('كم شهر تمدد الاشتراك؟', '1')||'0'); if(!months || months<=0) return; const now = Date.now(); acc.subscriptionExpires = Math.max(acc.subscriptionExpires||0, now) + months*30*24*60*60*1000; acc.subscriptionActive = true; await idbPut('accounts', acc); alert('تم تمديد الاشتراك'); renderUsersManager(); }
      if(act==='cert'){ const months = parseInt(prompt('كم شهر للشهادة (مثال:1)', '1')||'0'); if(!months || months<=0) return; const now = Date.now(); acc.certificateExpires = Math.max(acc.certificateExpires||0, now) + months*30*24*60*60*1000; await idbPut('accounts', acc); alert('تمت إضافة/تمديد الشهادة'); renderUsersManager(); }
      if(act==='lock'){ acc.locked = !acc.locked; await idbPut('accounts', acc); alert(acc.locked? 'تم قفل الحساب':'تم فتح الحساب'); renderUsersManager(); }
      if(act==='exportfiles'){ await downloadUserExport(acc.id); }
      if(act==='cancel'){ if(!confirm('هل تريد إلغاء الاشتراك لهذا الحساب؟')) return; acc.subscriptionActive = false; acc.subscriptionExpires = Date.now()-1000; await idbPut('accounts', acc); alert('تم إلغاء الاشتراك'); renderUsersManager(); }
      if(act==='del'){ if(!confirm('حذف الحساب؟ هذه العملية نهائية')) return; // do not delete files; keep them per requirement
        await idbDelete('accounts', id); alert('تم حذف الحساب (الملفات تبقى محفوظة)'); renderUsersManager(); }
    });
  }
}

/* ---------- edit user modal extended (lockOnCertExpire + manual locked flag) ---------- */
function showEditUserModal(acc){ showModal(`<div class="modal"><h3>تعديل الحساب — ${escapeHtml(acc.name)}</h3>
  <div class="form-row"><label>الاسم</label><input id="eu_name" value="${escapeHtml(acc.name)}"></div>
  <div class="form-row"><label>دور</label><select id="eu_role"><option value="user">مستخدم</option><option value="admin">أدمن</option></select></div>
  <div class="form-row"><label>تفعيل الاشتراك</label><input id="eu_subactive" type="checkbox"></div>
  <div class="form-row"><label>تاريخ انتهاء الاشتراك (تاريخ أو فارغ)</label><input id="eu_subexp" placeholder="مثال: 2025-12-31"></div>
  <div class="form-row"><label>تاريخ انتهاء الشهادة (تاريخ أو فارغ)</label><input id="eu_certexp" placeholder="مثال: 2025-12-31"></div>
  <div class="form-row"><label><input id="eu_lockOnCert" type="checkbox"> قفل الحساب تلقائيًا عند انتهاء الشهادة</label></div>
  <div class="form-row"><label><input id="eu_locked" type="checkbox"> حساب مقفل (يدوياً)</label></div>
  <div style="display:flex;gap:8px"><button id="eu_save" class="btn">حفظ</button> <button id="eu_cancel" class="btn">إلغاء</button></div>
</div>`);
  document.getElementById('eu_role').value = acc.role||'user'; document.getElementById('eu_subactive').checked = !!acc.subscriptionActive;
  document.getElementById('eu_subexp').value = acc.subscriptionExpires? new Date(acc.subscriptionExpires).toISOString().slice(0,10):'';
  document.getElementById('eu_certexp').value = acc.certificateExpires? new Date(acc.certificateExpires).toISOString().slice(0,10):'';
  document.getElementById('eu_lockOnCert').checked = !!acc.lockOnCertExpire;
  document.getElementById('eu_locked').checked = !!acc.locked;
  document.getElementById('eu_cancel').onclick = closeModal;
  document.getElementById('eu_save').onclick = async ()=>{
    acc.name = (document.getElementById('eu_name')||{}).value||acc.name;
    acc.role = (document.getElementById('eu_role')||{}).value||acc.role;
    acc.subscriptionActive = !!document.getElementById('eu_subactive').checked;
    const sVal = (document.getElementById('eu_subexp')||{}).value; acc.subscriptionExpires = sVal ? new Date(sVal).getTime() : 0;
    const cVal = (document.getElementById('eu_certexp')||{}).value; acc.certificateExpires = cVal ? new Date(cVal).getTime() : 0;
    acc.lockOnCertExpire = !!document.getElementById('eu_lockOnCert').checked;
    acc.locked = !!document.getElementById('eu_locked').checked;
    await idbPut('accounts', acc); alert('تم حفظ التغييرات'); closeModal(); renderUsersManager(); };
}

/* ---------- user area (client view) with file manager ---------- */
async function renderUserArea(){ const area=$('#userArea'); if(!area) return; const acc = await idbGet('accounts', currentUser.id); if(!acc) return; let html = `<div><strong>${escapeHtml(acc.name)}</strong> — ${escapeHtml(acc.email)}</div>`; 
  const now=Date.now(); const subActive = acc.subscriptionActive && acc.subscriptionExpires && acc.subscriptionExpires > now; const subDate = acc.subscriptionExpires? new Date(acc.subscriptionExpires).toLocaleString() : 'لا يوجد';
  html += `<div class="small">اشتراك: ${subActive? '<span class="success">نشط</span>':'<span class="danger">منتهي</span>'} — ينتهي: ${subDate}</div>`;
  const certActive = acc.certificateExpires && acc.certificateExpires > now; const certDate = acc.certificateExpires? new Date(acc.certificateExpires).toLocaleString() : '-';
  html += `<div class="small">الشهادة: ${certActive? '<span class="success">سارية</span>':'<span class="danger">انتهت</span>'} — تنتهي: ${certDate}</div>`;
  if(!subActive) html += `<div style="margin-top:8px" class="item"><strong class="danger">تنبيه:</strong> اشتراكك منتهي — تواصل مع الأدمن للتجديد.</div>`;
  if(!certActive) html += `<div style="margin-top:8px" class="item"><strong class="danger">ملاحظة:</strong> الشهادة منتهية.</div>`;
  html += `<div style="height:12px"></div><div><button id="chgPwdBtn" class="btn">تغيير كلمة المرور</button></div>`;
  html += `<div style="height:12px"></div>`;
  // file manager area
  html += `<div id="fileManagerRoot"></div>`;
  area.innerHTML = html;
  document.getElementById('chgPwdBtn').onclick = ()=> showChangePasswordModal(currentUser.id);
  await renderFileManagerForUser(currentUser.id);
}

/* ---------- file manager UI ---------- */
async function renderFileManagerForUser(userId){
  const root = document.getElementById('fileManagerRoot'); if(!root) return;
  let currentFolder = ''; // simple flat folder path (no deep nesting) — can be extended
  let sortBy = 'name'; let sortDir = 'asc';
  async function draw(){
    const folders = (await getAllUserFolders(userId)).map(f=>f.name);
    const files = await getUserFiles(userId, currentFolder);
    files.sort((a,b)=>{
      let v = 0;
      if(sortBy === 'name') v = a.name.localeCompare(b.name);
      if(sortBy === 'createdAt') v = (a.createdAt||0) - (b.createdAt||0);
      if(sortBy === 'size') v = (a.size||0) - (b.size||0);
      return sortDir === 'asc' ? v : -v;
    });
    let html = `<div class="files-toolbar">
      <div class="folder-breadcrumb">المجلد: <strong>${currentFolder || '/'}</strong></div>
      <div style="flex:1"></div>
      <button id="btnCreateFolder" class="btn">مجلد جديد</button>
      <label class="btn">رفع ملف<input id="fileUploadInput" type="file" style="display:none"></label>
      <select id="sortSelect"><option value="name">ترتيب حسب الاسم</option><option value="createdAt">ترتيب حسب التاريخ</option><option value="size">ترتيب حسب الحجم</option></select>
      <select id="dirSelect"><option value="asc">تصاعدي</option><option value="desc">تنازلي</option></select>
      <button id="exportUserFilesBtn" class="btn">تصدير JSON لملفاتي</button>
    </div>`;
    html += `<div style="display:flex;gap:12px;margin-top:8px"><div style="width:220px">`;
    html += `<div class="card"><h4>المجلدات</h4><div class="list">`;
    html += `<div class="item" data-folder=""><strong>/</strong> <span class="small">جذر</span></div>`;
    folders.forEach(fn=> html += `<div class="item" data-folder="${escapeHtml(fn)}">${escapeHtml(fn)}</div>`);
    html += `</div></div></div>`;
    html += `<div style="flex:1"><div class="card"><h4>المحتوى</h4><div class="file-list">`;
    if(files.length===0) html += `<div class="small">لا توجد ملفات أو مجلدات هنا.</div>`;
    for(const f of files){
      html += `<div class="file-row" data-id="${f.id}" data-type="${f.type}">
        <div style="display:flex;gap:12px;align-items:center">
          <div style="min-width:220px"><strong>${escapeHtml(f.name)}</strong><div class="muted small">${f.type==='folder' ? 'مجلد' : (f.mime||'')} — ${f.size ? (f.size + ' بايت') : ''}</div></div>
        </div>
        <div style="display:flex;gap:6px;align-items:center">
          ${f.type==='file' ? `<button class="btn file-download" data-id="${f.id}">تحميل</button>` : `<button class="btn file-open" data-id="${f.id}">فتح</button>`}
          <button class="btn file-rename" data-id="${f.id}">إعادة تسمية</button>
          <button class="btn file-move" data-id="${f.id}">نقل</button>
          <button class="btn file-delete" data-id="${f.id}">حذف</button>
        </div>
      </div>`;
    }
    html += `</div></div></div></div>`;
    root.innerHTML = html;

    // bind events
    document.getElementById('btnCreateFolder').onclick = async ()=>{ const name = prompt('اسم المجلد'); if(!name) return; await createFolder(userId, '', name); draw(); };
    const fileInput = document.getElementById('fileUploadInput');
    fileInput.onchange = async (ev)=>{ const f = ev.target.files[0]; if(!f) return; await uploadFileObject(userId, currentFolder, f); fileInput.value=''; draw(); };
    document.getElementById('sortSelect').value = sortBy; document.getElementById('dirSelect').value = sortDir;
    document.getElementById('sortSelect').onchange = (e)=>{ sortBy = e.target.value; draw(); };
    document.getElementById('dirSelect').onchange = (e)=>{ sortDir = e.target.value; draw(); };
    document.getElementById('exportUserFilesBtn').onclick = async ()=>{ await downloadUserExport(userId); };

    root.querySelectorAll('.item[data-folder]').forEach(el=> el.onclick = ()=>{ currentFolder = el.dataset.folder; draw(); });

    root.querySelectorAll('.file-download').forEach(b=> b.onclick = async e=>{
      const id = e.target.dataset.id; const f = await idbGet('files', id); if(!f) return alert('لم أعثر على الملف');
      // create download link from blob
      if(!f.blob) return alert('لا يوجد محتوى للتحميل');
      const url = URL.createObjectURL(f.blob); const a = document.createElement('a'); a.href = url; a.download = f.name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),3000);
    });

    root.querySelectorAll('.file-open').forEach(b=> b.onclick = async e=>{
      const id = e.target.dataset.id; const f = await idbGet('files', id); if(!f) return; // for folder open into folder
      if(f.type==='folder'){ currentFolder = f.name; draw(); }
    });

    root.querySelectorAll('.file-rename').forEach(b=> b.onclick = async e=>{
      const id = e.target.dataset.id; const f = await idbGet('files', id); if(!f) return; const nn = prompt('الاسم الجديد', f.name); if(!nn) return; await renameFile(id, nn); draw();
    });

    root.querySelectorAll('.file-move').forEach(b=> b.onclick = async e=>{
      const id = e.target.dataset.id; const f = await idbGet('files', id); if(!f) return;
      const allFolders = (await getAllUserFolders(userId)).map(x=>x.name); const chosen = prompt('اختر المجلد الهدف (اكتب اسم المجلد او اترك فارغ للجذر)\nالمجلدات المتاحة: ' + allFolders.join(', '), f.folder||'');
      if(chosen===null) return;
      await moveFileTo(id, chosen||''); draw();
    });

    root.querySelectorAll('.file-delete').forEach(b=> b.onclick = async e=>{
      const id = e.target.dataset.id; if(!confirm('حذف؟')) return; await deleteFileEntry(id); draw();
    });
  }

  await draw();
}

/* ---------- change password modal (unchanged) ---------- */
function showChangePasswordModal(userId, forced=false){ showModal(`<div class="modal"><h3>تغيير كلمة المرور</h3>
  <div class="form-row"><label>كلمة المرور الحالية (إن وُجدت)</label><input id="cp_old" type="password"></div>
  <div class="form-row"><label>كلمة مرور جديدة</label><input id="cp_new" type="password"></div>
  <div class="form-row"><label>تأكيد</label><input id="cp_new2" type="password"></div>
  <div style="display:flex;gap:8px"><button id="cp_save" class="btn">حفظ</button> <button id="cp_cancel" class="btn">إلغاء</button></div>
</div>`);
  document.getElementById('cp_cancel').onclick = ()=>{ closeModal(); if(forced) { alert('يجب تغيير كلمة المرور للمتابعة'); showChangePasswordModal(userId,true); } };
  document.getElementById('cp_save').onclick = async ()=>{
    const oldV = (document.getElementById('cp_old')||{}).value||''; const n1 = (document.getElementById('cp_new')||{}).value||''; const n2 = (document.getElementById('cp_new2')||{}).value||'';
    if(!n1 || n1!==n2) return alert('تحقق من كلمة المرور الجديدة');
    const acc = await idbGet('accounts', userId);
    if(!acc) return alert('الحساب غير موجود');
    if(!acc.mustChangePassword){ // verify old
      if(!oldV) return alert('أدخل كلمة المرور الحالية');
      const ok = await verifyPassword(oldV, acc.passwordHash).catch(()=>false); if(!ok) return alert('كلمة المرور الحالية خاطئة');
    }
    acc.passwordHash = await hashPassword(n1); acc.mustChangePassword = false; await idbPut('accounts', acc);
    alert('تم تغيير كلمة المرور'); closeModal(); if(acc.role==='admin') await renderApp(); else { currentUser = acc; await renderApp(); }
  };
}

/* ---------- login flows (check locked flag) ---------- */
function showLoginModal(){ showModal(`<div class="modal"><h3>تسجيل دخول</h3>
  <div class="form-row"><label>البريد</label><input id="loginEmail" type="email"></div>
  <div class="form-row"><label>كلمة المرور</label><input id="loginPwd" type="password"></div>
  <div class="form-row"><label><input id="rememberLogin" type="checkbox"> تذكرني</label></div>
  <div class="form-row"><button id="doLogin" class="btn">دخول</button> <button id="forgotBtn" class="btn">نسيت كلمة المرور</button></div>
</div>`);
  document.getElementById('doLogin').onclick = doLogin;
  document.getElementById('forgotBtn').onclick = ()=>{ closeModal(); showForgotModal(); };
}

async function doLogin(){ try{
    const email = ((document.getElementById('loginEmail')||{}).value||'').trim().toLowerCase(); const pwd = (document.getElementById('loginPwd')||{}).value||''; const remember = (document.getElementById('rememberLogin')||{}).checked||false;
    if(!email||!pwd) return alert('املأ الحقول');
    const all = await idbGetAll('accounts'); const acc = all.find(a=>a.email===email);
    if(!acc) return alert('حساب غير موجود');
    if(acc.locked) return alert('هذا الحساب مقفل. تواصل مع الأدمن.');
    const ok = await verifyPassword(pwd, acc.passwordHash).catch(()=>false);
    if(!ok) return alert('كلمة المرور خاطئة');
    const s = await createSession(acc.id, remember); sessionToken = s; currentUser = acc; sessionStorage.setItem('currentUser', JSON.stringify(currentUser)); closeModal();
    // if must change password
    if(acc.mustChangePassword){ setTimeout(()=> showChangePasswordModal(acc.id,true),200); }
    await renderApp(); scheduleSessionExpiryCheck();
  }catch(e){ console.error(e); alert('خطأ في تسجيل الدخول'); } }

/* ---------- forgot/reset (unchanged) ---------- */
function showForgotModal(){ showModal(`<div class="modal"><h3>استعادة الحساب</h3>
  <div class="form-row"><label>البريد</label><input id="fpEmail" type="email"></div>
  <div class="form-row"><button id="sendReset" class="btn">إرسال رمز استعادة (محاكاة)</button></div>
</div>`);
  document.getElementById('sendReset').onclick = async ()=>{ const email = ((document.getElementById('fpEmail')||{}).value||'').trim().toLowerCase(); if(!simpleEmailCheck(email)) return alert('بريد خاطئ'); const all = await idbGetAll('accounts'); const acc = all.find(a=>a.email===email); if(!acc) return alert('لا يوجد حساب بهذا البريد'); const code = (Math.floor(Math.random()*900000)+100000).toString(); await idbPut('verifications',{id:acc.id,code,expires:Date.now()+1000*60*30,purpose:'reset'}); alert('رمز الاستعادة (محاكاة): ' + code); closeModal(); showResetModal(acc.id); } }
function showResetModal(accountId){ showModal(`<div class="modal"><h3>إعادة تعيين كلمة المرور</h3>
  <div class="form-row"><label>رمز الاستعادة</label><input id="resetCode"></div>
  <div class="form-row"><label>كلمة مرور جديدة</label><input id="resetPwd" type="password"></div>
  <div class="form-row"><label>تأكيد</label><input id="resetPwd2" type="password"></div>
  <div class="form-row"><button id="doReset" class="btn">تعيين</button></div>
</div>`);
  document.getElementById('doReset').onclick = async ()=>{ const code = (document.getElementById('resetCode')||{}).value || ''; const p1 = (document.getElementById('resetPwd')||{}).value || ''; const p2 = (document.getElementById('resetPwd2')||{}).value || ''; if(!code || !p1 || !p2) return alert('املأ الحقول'); if(p1 !== p2) return alert('كلمة المرور غير متطابقة'); const ver = await idbGet('verifications', accountId).catch(()=>null); if(!ver || ver.purpose!=='reset') return alert('رمز غير صالح'); if(Date.now() > ver.expires) return alert('رمز منتهي'); if(code !== ver.code) return alert('رمز خاطئ'); const hashed = await hashPassword(p1); const acc = await idbGet('accounts', accountId); acc.passwordHash = hashed; acc.mustChangePassword = false; await idbPut('accounts', acc); await idbDelete('verifications', accountId); alert('تم تغيير كلمة المرور'); closeModal(); } }

/* ---------- backup / import (unchanged except DB ver) ---------- */
async function downloadBackup(){ const accounts = await idbGetAll('accounts'); const files = await idbGetAll('files'); const serial = {exportedAt:new Date().toISOString(), accounts: accounts.map(a=>{const c=Object.assign({},a); delete c.passwordHash; return c;}), files: files.map(f=>{const c=Object.assign({},f); if(c.blob) delete c.blob; return c; })}; const blob = new Blob([JSON.stringify(serial,null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download = `ibsar_backup_${new Date().toISOString().replace(/[:.]/g,'-')}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(url),3000); }
function showImportModal(){ showModal(`<div class="modal"><h3>استيراد نسخة (JSON)</h3><div class="form-row"><input id="importFile" type="file" accept="application/json"></div><div class="form-row"><button id="doImport" class="btn">استيراد</button> <button id="cancelImport" class="btn">إلغاء</button></div></div>`); document.getElementById('cancelImport').onclick = closeModal; document.getElementById('doImport').onclick = async ()=>{ const f=(document.getElementById('importFile')||{}).files[0]; if(!f) return alert('اختر ملف JSON'); const txt = await f.text(); try{ const data = JSON.parse(txt); if(data.accounts){ for(const a of data.accounts){ // avoid overwriting admin
      if(a.email===ADMIN_EMAIL) continue; await idbPut('accounts', Object.assign({id: uid()}, a)); }
      alert('تم الاستيراد (بعض الحقول قد تُخطأ)'); closeModal(); await renderApp(); } else alert('ملف غير صالح'); }catch(e){ alert('خطأ في الملف'); } } }

/* ---------- download per-user JSON export (includes base64 file contents) ---------- */
async function downloadUserExport(userId){
  const acc = await idbGet('accounts', userId); if(!acc) return alert('المستخدم غير موجود');
  const files = (await idbGetAll('files')).filter(f=> f.ownerId === userId);
  const out = { exportedAt: new Date().toISOString(), user: { id: acc.id, name: acc.name, email: acc.email }, files: [] };
  // convert blobs to base64 sequentially to avoid memory spike
  for(const f of files){
    const entry = { id: f.id, name: f.name, type: f.type, folder: f.folder||'', size: f.size||0, mime: f.mime||'', createdAt: f.createdAt||0, updatedAt: f.updatedAt||0 };
    if(f.type === 'file' && f.blob){
      try{
        const b64 = await blobToBase64(f.blob);
        entry.contentBase64 = b64;
      }catch(e){
        entry.contentBase64 = null;
      }
    }
    out.files.push(entry);
  }
  const blob = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `ibsar_user_export_${acc.email.replace(/[@.]/g,'_')}_${new Date().toISOString().replace(/[:.]/g,'-')}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),3000);
}

/* ---------- window protections minimal (unchanged) ---------- */
(function anti(){ const wm=document.getElementById('watermark'); function update(){ wm.textContent=(currentUser && currentUser.email)? currentUser.email:'إبصار'; }
  document.addEventListener('contextmenu',e=>{ /*e.preventDefault(); showBlock('منع قائمة السياق');*/ });
  const ub=$('#unblockBtn'); if(ub) ub.onclick=()=>{ blocked=false; $('#blocker').style.display='none'; renderApp(); };
  setInterval(update,1000);
})();

function showBlock(reason){ blocked=true; $('#blockReason').textContent=reason; $('#blocker').style.display='flex'; }

/* ---------- session expiry ---------- */
function scheduleSessionExpiryCheck(){ if(sessionChecker) clearInterval(sessionChecker); sessionChecker=setInterval(async()=>{ if(!sessionToken) return; if(Date.now()>sessionToken.expires){ try{ alert('انتهت الجلسة — سيتم تسجيل الخروج'); }catch(e){} await endSession(); } },60*1000); }

/* ---------- bootstrap: create admin if missing ---------- */
(async function init(){ document.getElementById('openPanel').onclick = ()=> { renderApp(); window.scrollTo({ top: 0, behavior: 'smooth' }); };
  try{ const accounts = await idbGetAll('accounts'); const found = accounts.find(a=> a.email === ADMIN_EMAIL);
    if(!found){ const hashed = await hashPassword(ADMIN_PLAIN); const id = uid(); const admin = { id, name:'مدير النظام', email: ADMIN_EMAIL, passwordHash: hashed, role:'admin', mustChangePassword:false, subscriptionExpires: 0, subscriptionActive:false, certificateExpires:0, emailVerified:true, createdAt:Date.now(), lockOnCertExpire:false, locked:false }; await idbPut('accounts', admin); console.info('Admin created'); }
  }catch(e){ console.warn('admin creation failed', e); }
  try{ await enforceCertificateLocks(); const s = await loadSessionFromStorage(); if(s){ sessionToken = s; const user = await idbGet('accounts', s.userId).catch(()=>null); if(user){ currentUser = user; try{ sessionStorage.setItem('currentUser', JSON.stringify(currentUser)); }catch(e){} } }
  }catch(e){ console.warn('session load failed', e); }
  try{ const su = sessionStorage.getItem('currentUser'); if(!currentUser && su) currentUser = JSON.parse(su); }catch(e){}
  try{ await renderApp(); }catch(err){ console.error('renderApp error', err); alert('خطأ داخلي'); }
  scheduleSessionExpiryCheck();
})();

// expose debug & helpers
window.IBSAR = { idbGetAll, idbPut, idbGet, idbDelete, createFolder, uploadFileObject, getUserFiles, moveFileTo, renameFile, deleteFileEntry, downloadUserExport };
</script>
</body>
</html>

